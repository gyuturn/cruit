name: Fetch Jobs via API (Batch)

# 공공기관 채용정보 API(data.go.kr)를 통한 채용공고 수집
# Issue #18 - 크롤링(#15) 대신 공식 API 사용

on:
  schedule:
    # 하루 2회 실행 (KST 06:00, 18:00 = UTC 21:00, 09:00)
    - cron: '0 21 * * *'
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    environment: prd

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Fetch Jobs from Recruitment API
        run: npx tsx scripts/fetch-jobs-api.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
          RECRUITMENT_API_KEY: ${{ secrets.RECRUITMENT_API_KEY }}

      - name: Report Status
        if: always()
        run: |
          echo "API fetch job completed at $(date)"
          echo "Status: ${{ job.status }}"
