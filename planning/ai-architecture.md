# AI 추천 시스템 아키텍처

## 1. 현재 구조 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              사용자 요청                                      │
│                    POST /api/recommendations                                 │
│                    { profile, page, limit, refresh }                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           1. 크롤링 단계                                      │
│                         fetchJobs(source, profile)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  프로필 기반 키워드 생성                                               │   │
│  │  - 전공 → 관련 키워드 (컴퓨터 → 개발자, IT, 소프트웨어)                 │   │
│  │  - 자격증 → 관련 키워드 (정보처리 → IT, SQL → 데이터)                  │   │
│  │  - 경력 수준 필터 (신입/경력)                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│              ┌─────────────────────┼─────────────────────┐                 │
│              ▼                     ▼                     ▼                 │
│     ┌──────────────┐      ┌──────────────┐      ┌──────────────┐          │
│     │   사람인      │      │   잡코리아    │      │  샘플 데이터  │          │
│     │  (saramin)   │      │  (jobkorea)  │      │  (fallback)  │          │
│     └──────────────┘      └──────────────┘      └──────────────┘          │
│              │                     │                     │                 │
│              └─────────────────────┼─────────────────────┘                 │
│                                    ▼                                        │
│                          중복 제거 (회사+제목)                                │
│                                    │                                        │
│                              JobPosting[]                                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           2. 추천 단계                                       │
│                   getRecommendations(profile, jobs, useAI)                  │
│                                                                             │
│                         ┌─────────────────┐                                 │
│                         │ useAI = true?   │                                 │
│                         │ OPENAI_API_KEY? │                                 │
│                         └────────┬────────┘                                 │
│                                  │                                          │
│                    ┌─────────────┴─────────────┐                           │
│                    ▼                           ▼                           │
│         ┌─────────────────────┐    ┌─────────────────────┐                │
│         │   AI 기반 추천       │    │   규칙 기반 추천     │                │
│         │ (OpenAI GPT-3.5)    │    │ (점수 계산 알고리즘) │                │
│         └─────────────────────┘    └─────────────────────┘                │
│                    │                           │                           │
│                    └─────────────┬─────────────┘                           │
│                                  ▼                                          │
│                         Recommendation[]                                    │
│                    (매칭 점수 기준 정렬됨)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          3. 응답 단계                                        │
│                                                                             │
│  {                                                                          │
│    recommendations: [...],  // 페이지네이션 적용                              │
│    pagination: { page, limit, total, hasMore },                             │
│    meta: { crawledCount, sources }                                          │
│  }                                                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. AI 모델 및 API 정보

### 2.1 사용 모델

| 항목 | 값 |
|---|---|
| **Provider** | OpenAI |
| **모델명** | `gpt-3.5-turbo` |
| **API 버전** | Chat Completions API |
| **환경변수** | `OPENAI_API_KEY` |

### 2.2 모델 설정

```typescript
// src/lib/ai/index.ts

const response = await openai.chat.completions.create({
  model: 'gpt-3.5-turbo',
  messages: [{ role: 'user', content: prompt }],
  temperature: 0.3,      // 일관성 높은 응답
  max_tokens: 2000,      // 최대 출력 토큰
});
```

### 2.3 API 키 발급 방법

1. [OpenAI Platform](https://platform.openai.com/) 접속
2. 계정 생성 또는 로그인
3. **API Keys** 메뉴에서 새 키 생성
4. `.env.local` 파일에 설정:
   ```bash
   OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx
   ```

### 2.4 비용 정보 (2024년 기준)

| 모델 | Input (1K tokens) | Output (1K tokens) |
|---|---|---|
| **gpt-3.5-turbo** | $0.0005 | $0.0015 |
| gpt-4 | $0.03 | $0.06 |
| gpt-4-turbo | $0.01 | $0.03 |

#### 예상 비용 계산

```
1회 추천 요청 기준:
- 프롬프트 (Input): ~1,500 tokens ≈ $0.00075
- 응답 (Output): ~500 tokens ≈ $0.00075
- 1회 비용: 약 $0.0015 (≈ 2원)

월 1,000회 요청 시: 약 $1.5 (≈ 2,000원)
```

#### 무료 크레딧

- 신규 가입 시 **$5 무료 크레딧** 제공 (3개월 유효)
- 약 3,000회 이상 AI 추천 가능

---

## 3. 별점(평점) 시스템 현황

### 3.1 현재 구현 상태

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        별점 시스템 흐름 (현재)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [사용자]                                                                    │
│     │                                                                       │
│     ▼                                                                       │
│  ┌──────────────────┐                                                       │
│  │  별점 클릭 (1-5)  │                                                       │
│  └────────┬─────────┘                                                       │
│           │                                                                 │
│           ▼                                                                 │
│  ┌──────────────────┐                                                       │
│  │   LocalStorage   │  ← 클라이언트에만 저장                                 │
│  │  (브라우저 저장)  │                                                       │
│  └──────────────────┘                                                       │
│           │                                                                 │
│           ╳ ─── 서버 전송 없음                                               │
│           ╳ ─── AI 학습 반영 없음                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 상세 점검 결과

| 항목 | 현재 상태 | 설명 |
|---|---|---|
| **별점 UI** | ✅ 구현됨 | 1-5점 별점 선택 가능 |
| **별점 저장** | ⚠️ LocalStorage만 | 브라우저에만 저장, 서버 미전송 |
| **별점 조회** | ✅ 구현됨 | 저장된 별점 불러오기 |
| **서버 전송** | ❌ 미구현 | API 엔드포인트 없음 |
| **AI 학습 반영** | ❌ 미구현 | 추천 알고리즘에 반영 안됨 |

### 3.3 관련 코드

```typescript
// src/lib/storage.ts - 별점 저장 (LocalStorage만)

export function saveRating(jobId: string, rating: number): void {
  if (typeof window !== 'undefined') {
    const ratings = getRatings();
    // ... LocalStorage에만 저장
    localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));
  }
}

// src/components/JobCard.tsx - 별점 UI
const handleRating = (value: number) => {
  setRating(value);
  saveRating(jobPosting.id, value);  // LocalStorage 저장만
  onRatingChange?.(jobPosting.id, value);  // 콜백 (현재 미사용)
};
```

### 3.4 문제점

1. **데이터 휘발성**: 브라우저 데이터 삭제 시 별점 손실
2. **학습 불가**: AI가 사용자 피드백을 학습할 수 없음
3. **개인화 제한**: 별점 기반 추천 개선 불가능

---

## 4. 추천 알고리즘 상세

### 4.1 규칙 기반 추천 (기본) - v2 업데이트

```typescript
// 파일: src/lib/ai/index.ts - calculateMatchScore()

기본 점수: 50점

[경력 조건 매칭]
+20점: 신입 프로필 + 신입/무관 공고
+15점: 경력 프로필 + 경력 공고
+15점: 신입/경력 모두 가능한 공고

[경력 연차 매칭] (경력자만)
+10점: 요구 연차 충족 (예: 3년 이상 요구, 3년 이상 보유)
+5점: 요구 연차 근접 (70% 이상)
+5점: 연차 조건 명시 없음

[학력 조건 매칭]
+10점: 4년제 프로필 + 대졸 요구 공고
+10점: 학력 무관 공고

[자격증 매칭]
+10점 (per cert): 프로필 자격증 ↔ 공고 요구 스킬 비교

[전공 관련도]
+10점: IT 관련 전공 (컴퓨터, 소프트웨어, 정보, 전산, 데이터)

[직무 연관성] (경력자만)
+5점 (per keyword): 이전 직무 ↔ 공고 직무 키워드 매칭
  - 키워드: 개발, 엔지니어, 프론트, 백엔드, 풀스택, 데이터, AI, ML

최종 점수: 0 ~ 100 (clamp)
```

### 4.2 AI 기반 추천 (OpenAI) - v2 업데이트

```typescript
// 파일: src/lib/ai/index.ts - getAIRecommendations()

[프롬프트 구조]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
당신은 취업 매칭 전문가입니다.

## 사용자 프로필
- 경력 구분: 신입/경력
- 총 경력 기간: {총 경력 기간}
- 경력 사항: {회사명(직무, 시작~종료), ...}
- 학력: {대학교명} ({지역}) - 4년제
- 전공: {major}
- 자격증: {certifications}

## 채용 공고 목록
- ID: 1
  제목: ...
  회사: ...
  위치: ...
  경력조건: ...
  학력조건: ...
  요구기술: ...
  요약: ...

## 응답 형식 (JSON만 출력)
[{"id": "공고ID", "score": 85, "reasons": ["이유1", "이유2"]}, ...]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Fallback]
- AI 실패 시 → 규칙 기반 추천으로 자동 전환
- AI 결과 부족 시 → 나머지는 규칙 기반으로 보충
```

---

## 5. 데이터 흐름

### 5.1 입력 데이터

```typescript
// 사용자 프로필 (UserProfile)
{
  experienceLevel: 'junior' | 'experienced',  // 신입/경력
  isFourYearUniv: boolean,                     // 4년제 여부
  universityRegion?: string,                   // 대학교 지역
  universityName?: string,                     // 대학교명
  major: string,                               // 전공
  certifications: string[],                    // 자격증
  careerHistory?: CareerHistory[],             // 경력사항
}
```

### 5.2 크롤링 데이터

```typescript
// 채용 공고 (JobPosting)
{
  id: string,
  title: string,              // 공고 제목
  company: string,            // 회사명
  location: string,           // 근무지
  experienceLevel: string,    // 경력 조건
  education: string,          // 학력 조건
  skills: string[],           // 요구 기술/자격증
  salary: string,             // 급여
  deadline: string,           // 마감일
  url: string,                // 원본 링크
  source: 'saramin' | 'jobkorea' | 'sample',
  summary: string,
}
```

### 5.3 출력 데이터

```typescript
// 추천 결과 (Recommendation)
{
  jobPosting: JobPosting,
  matchScore: number,         // 0-100
  matchReasons: string[],     // 매칭 이유
  userRating?: number,        // 사용자 평점 (1-5) - 현재 미사용
}
```

---

## 6. 검토 결과 요약

### 6.1 현재 구현 상태

| 기능 | 상태 | 설명 |
|---|---|---|
| 프로필 기반 크롤링 | ✅ 구현됨 | 전공/자격증으로 키워드 생성, 경력 필터 |
| 규칙 기반 추천 | ✅ 구현됨 | 경력/학력/자격증/전공 매칭 |
| AI 기반 추천 | ✅ 구현됨 | OpenAI GPT-3.5-turbo 사용 |
| 매칭 점수 | ✅ 구현됨 | 0-100점 |
| 매칭 이유 | ✅ 구현됨 | 태그 형태로 표시 |
| Fallback 처리 | ✅ 구현됨 | AI 실패 시 규칙 기반으로 전환 |
| **별점 저장** | ⚠️ 부분 구현 | LocalStorage만, 서버 미전송 |
| **별점 → AI 학습** | ❌ 미구현 | 피드백 반영 안됨 |

### 6.2 개선 필요 사항

| 우선순위 | 항목 | 현재 상태 | 개선 방안 |
|---|---|---|---|
| 🔴 높음 | 별점 서버 저장 | LocalStorage만 | API 엔드포인트 추가, DB 저장 |
| 🔴 높음 | 별점 AI 반영 | 미구현 | 추천 프롬프트에 피드백 포함 |
| 🟡 중간 | 크롤링 캐싱 | 없음 | Redis/파일 캐싱으로 성능 개선 |
| 🟢 낮음 | 모델 업그레이드 | gpt-3.5-turbo | gpt-4-turbo 옵션 추가 |

---

## 7. 트리거 조건

```
┌─────────────────────────────────────────────────────────────┐
│                     추천 트리거                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [최초 로드]                                                 │
│  프로필 저장 → 규칙 기반 추천 (빠른 응답, 무료)               │
│                                                             │
│  [갱신하기 버튼]                                              │
│  refresh=true → AI 기반 추천 (OpenAI API 호출, 유료)         │
│                                                             │
│  [더보기 버튼]                                                │
│  page++ → 다음 페이지 로드 (기존 결과에서 슬라이스)            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 환경 변수

```bash
# .env.local

# OpenAI API 키 (필수 - AI 추천 사용 시)
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxx

# 설정되지 않으면 규칙 기반 추천만 사용 (무료)
```

---

## 9. 파일 구조

```
src/
├── app/api/recommendations/
│   └── route.ts              # API 엔드포인트
│
├── lib/
│   ├── ai/
│   │   └── index.ts          # AI 추천 로직
│   │       ├── calculateMatchScore()      # 규칙 기반 점수
│   │       ├── generateMatchReasons()     # 매칭 이유 생성
│   │       ├── getAIRecommendations()     # OpenAI 추천
│   │       ├── getRuleBasedRecommendations()  # 규칙 기반 추천
│   │       └── getRecommendations()       # 메인 함수
│   │
│   ├── crawler/
│   │   ├── index.ts          # 크롤러 통합
│   │   ├── saramin.ts        # 사람인 크롤러
│   │   └── jobkorea.ts       # 잡코리아 크롤러
│   │
│   └── storage.ts            # LocalStorage 유틸 (별점 포함)
│
├── components/
│   └── JobCard.tsx           # 별점 UI 포함
│
└── types/
    └── index.ts              # 타입 정의
```

---

## 10. 결론

### 정상 동작 항목
1. ✅ 사용자 프로필 정보 수집 (대학교, 경력 포함)
2. ✅ 프로필 기반 취업 사이트 크롤링
3. ✅ 크롤링된 데이터를 AI(OpenAI)로 분석
4. ✅ 사용자에게 가장 적합한 공고 추천
5. ✅ 매칭 점수와 이유 제공

### 미흡한 항목
1. ❌ **별점이 서버로 전송되지 않음** (LocalStorage만 저장)
2. ❌ **별점이 AI 학습에 반영되지 않음** (추천 개선 불가)
3. ❌ 크롤링 결과 캐싱 없음 (매번 새로 크롤링)

### 권장 개선 작업
1. 별점 API 엔드포인트 생성 (`POST /api/ratings`)
2. 별점 데이터를 AI 프롬프트에 포함
3. 높은 평점 공고와 유사한 공고 우선 추천
